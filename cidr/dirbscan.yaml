name: dirbscan
desc: Run Dirbscan

report:
  final:
    - "{{.Output}}/directory/beautify-{{.Workspace}}.txt"
    - "{{.Output}}/directory/summary-{{.Workspace}}.csv"

params:
  - httpFile: "{{.Output}}/portscan/http-running.txt"
  - wordlists: "{{.Data}}/wordlists/content/small.txt"
  - dirbThreads: '30' # threads for single site
  - ffThreads: '15' # threads for running number of ffuf commands
  - limit: '35000'
  - recursion: '0'
  - chan: '#mics'
  - lines: "30"
  - ffTimeout: '2h'

pre_run:
  - CreateFolder("{{.Storages}}/paths/{{.Workspace}}")
  - CreateFolder("{{.Output}}/directory")

steps:
  # check wildcard before brute force dns. We don't want tons of garbage here
  - conditions:
      - "FileLength('{{.httpFile}}') > {{.limit}}"
    scripts:
      - ErrPrintf("Filter", "Got input file greater than {{.limit}} line")
      - Exit(1)

  - required:
      - "{{.Binaries}}/ffuf"
      - "{{.httpFile}}"
    source: "{{.httpFile}}"
    threads: '{{.dirbThreads}}'
    commands:
      - "{{.Binaries}}/ffuf -t {{.ffThreads}} -s -timeout 15 -ac -fc '429,403,404' -D -e 'asp,aspx,pl,php,html,htm,jsp,cgi' -of json -o {{.Output}}/directory/raw-[[._id_]].json -u '[[.line]]/FUZZ' -w {{.wordlists}}:FUZZ"


  # clean up and generate beautify report
  - scripts:
      - ExecCmd("cat {{.Output}}/directory/raw-*.json | jq -r '.results[] | [.url,.status,.length,.words,.lines,.redirectlocation] | join(\",\")' > {{.Output}}/directory/beautify-{{.Workspace}}.csv")
      - ExecCmd("cat {{.Output}}/directory/beautify-{{.Workspace}}.csv | {{.Binaries}}/csvtk pretty -I -s ' | ' -W 75 > {{.Output}}/directory/beautify-{{.Workspace}}.txt")
      - TeleMessByFile("#dirb", "{{.Output}}/directory/beautify-{{.Workspace}}.txt")
      - Cat('{{.Output}}/directory/beautify-{{.Workspace}}.txt')
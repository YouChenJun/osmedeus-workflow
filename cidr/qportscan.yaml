name: portscan
desc: portscan on common HTTP ports

report:
  final:
    - "{{.Output}}/portscan/open-ports.txt"
    - "{{.Output}}/portscan/http-running.txt"
    - "{{.Output}}/portscan/{{.Workspace}}-aquatone/portscan-{{.Workspace}}.html"
    - "{{.Output}}/portscan/{{.Workspace}}-aquatone/aquatone_report.html"
    - "{{.Output}}/portscan/ssl-info.txt"

params:
  - inputfile: "{{.Target}}"
  - screen: "true"
  # more port
  - rate: "20000"
  - pthreads: "100"
  - mport: "8000"
  - scrthreads: "5"
  - ports: "1010,10250,10251,10443,12443,1311,16080,16686,18091,18092,20720,2082,2087,2095,2096,2480,28017,300,3000,3128,3333,4243,443,4567,4711,4712,4993,5000,5104,5108,5800,591,593,6443,6543,7000,7396,7474,7779,80,8000,8001,8008,8014,8042,8069,8080,8081,8088,8090,8091,81,8118,8123,8172,8222,8243,8280,8281,832,8333,8443,8500,8834,8880,8888,8983,9000,9043,9060,9080,9090,9091,9200,9443,9800,981,9981,11443,7443,3001,8009"

pre_run:
  - CreateFolder("{{.Storages}}/ports/{{.Workspace}}")
  - CreateFolder("{{.Output}}/portscan")
  - CreateFolder("{{.Output}}/portscan/raw")

steps:
  # do port scan first
  - required:
      - '{{.Binaries}}/rustscan'
    commands:
      - "{{.Binaries}}/rustscan --timeout 3000 -b {{.rate}} --scripts None -p {{.ports}}  -a {{.inputfile}} -g >> {{.Output}}/portscan/raw-open-ports.txt"
    scripts:
      - CleanRustScan("{{.Output}}/portscan/raw-open-ports.txt", "{{.Output}}/portscan/open-ports.txt")

  # detect HTTP running
  - commands:
      - cat {{.Output}}/portscan/open-ports.txt | {{.Binaries}}/httprobe -c 200 -t 10000 > {{.Output}}/portscan/http-running.txt
      - cat {{.Output}}/portscan/open-ports.txt | {{.Binaries}}/cinfo -json -c 100 > {{.Output}}/portscan/ssl-info.txt
  - scripts:
      - Copy("{{.Output}}/portscan/open-ports.txt", "{{.Storages}}/ports/{{.Workspace}}/portscan-{{.Workspace}}.txt")
      - Copy("{{.Output}}/portscan/http-running.txt", "{{.Storages}}/ports/{{.Workspace}}/http-port-{{.Workspace}}.txt")

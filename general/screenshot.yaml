name: screenshot
desc: Screenshot based on result of probing

report:
  final:
    - "{{.Output}}/screenshot/{{.Workspace}}-aquatone/screenshot-{{.Workspace}}.html"
    - "{{.Output}}/screenshot/goverview/report.html"

params:
  - inputfile: "{{.Output}}/probing/diffhttp-{{.Workspace}}.txt"
  - threads: "8"
  - limit: "50000"

# {{.Output}} == {{.Workspaces}} + {{.Workspace}} but strip "/" char
pre_run:
  - CreateFolder("{{.Output}}/screenshot")

steps:
  # check if the size is too big, We don't want tons of garbage here
  - conditions:
      - "FileLength('{{.inputfile}}') > {{.limit}}"
    scripts:
      - ErrPrintf("Filter", "Got input file greater than {{.limit}} line")
      - Exit(1)

  # only screenshot the one have different hash
  - required:
      - "{{.Binaries}}/aquatone"
      - "{{.inputfile}}"
    commands: 
      - "cat {{.inputfile}} | {{.Binaries}}/aquatone -threads {{.threads}} -out {{.Output}}/screenshot/{{.Workspace}}-aquatone > /dev/null 2>&1"
  # change html report name
  - commands:
      - "mv {{.Output}}/screenshot/{{.Workspace}}-aquatone/aquatone_report.html {{.Output}}/screenshot/{{.Workspace}}-aquatone/screenshot-{{.Workspace}}.html"
      - "ls {{.Output}}/screenshot/{{.Workspace}}-aquatone/screenshots/ > {{.Output}}/screenshot/number-of-screenshot.txt"

  # do screenshot with goverview
  - scripts:
      - ExecCmd("cat {{.inputfile}} | {{.Binaries}}/goverview screen -c 5 --json -o {{.Output}}/screenshot/goverview/")
      - ExecCmd("{{.Binaries}}/goverview report -o {{.Output}}/screenshot/goverview/ --report report.html")

post_run:
  - TotalScreenShot('{{.Output}}/screenshot/number-of-screenshot.txt')
